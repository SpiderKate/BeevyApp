{% extends "base.html" %}
{% block title %}Edit{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/register.css">
{% endblock %}

{% block content %}
<h1 class="shop-title">Edit an artwork</h1>

<form method="POST" enctype="multipart/form-data" class="edit-form">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- Title -->
    <label class="form-label">Title</label>
    <input type="text" name="title" required class="input" value="{{ item[2] }}">

    <!-- Description -->
    <label class="form-label">Description</label>
    <textarea class="desc" name="description">{{ item[3] }}</textarea>

    <!-- Slots -->
    <label class="form-label">Slots (optional)</label>
    <input type="number" name="slots" min="1" class="input" value="{{ item[11] }}">

    <!-- Thumbnail -->
    <label class="form-label">Thumbnail (cover image)</label>
    <input type="file" id="thumbInput" name="thumbnail" accept="image/*" class="input"
           data-max-size="{{ max_file_size }}" data-allowed="{{ allowed_extensions | join(',') }}"
           title="Max file size: {{ (max_file_size/1024/1024)|round(1) }} MB. Allowed: {{ allowed_extensions | join(', ') }}"
           aria-describedby="thumbHint">
    <div style="position: relative; display: inline-block;">
        <img id="thumbPreview" src="{{ url_for('static', filename=item[7]) if item[7] else url_for('static', filename='images/noThumb.png') }}" class="thumb-preview preview-img" alt="Thumbnail">
        <div style="position: absolute; top:0; left:0; width:100%; height:100%;"></div>
    </div>
    <div id="thumbError" class="file-error" style="color:#b00020; margin-top:6px;"></div>
    <div id="thumbHint" class="file-hint" style="font-size:0.9em; color:#666; margin-top:4px;">Max file size: {{ (max_file_size/1024/1024)|round(1) }} MB. Allowed: {{ allowed_extensions | join(', ') }}.</div>

    <!-- Examples -->
    <label class="form-label">Example images (optional)</label>
    <input type="file" id="examplesInput" name="examples" accept="image/*" multiple class="input"
           data-max-size="{{ max_file_size }}" data-allowed="{{ allowed_extensions | join(',') }}"
           title="Max file size per file: {{ (max_file_size/1024/1024)|round(1) }} MB. Allowed: {{ allowed_extensions | join(', ') }}"
           aria-describedby="examplesHint">
    {% for ex in examples_list %}
    <div style="position: relative; display: inline-block;">
        <img src="{{ url_for('static', filename=ex) }}" alt="Example" class="preview-img" >
        <div style="position: absolute; top:0; left:0; width:100%; height:100%;"></div>
    </div>
    {% endfor %}
    <div id="examplesPreview" class="preview-container"></div>
    <div id="examplesError" class="file-error" style="color:#b00020; margin-top:6px;"></div>
    <div id="examplesHint" class="file-hint" style="font-size:0.9em; color:#666; margin-top:4px;">Max file size per file: {{ (max_file_size/1024/1024)|round(1) }} MB. Allowed: {{ allowed_extensions | join(', ') }}.</div>

    <!-- Hide -->
     {% if item[13] == 1 %}
    <label class="form-label">Hide artwork in shop</label>
    <ul>
    <label>
        Type <b>HIDE</b> to confirm:
        <input type="text" name="confirmHide" class="input">
    </label>
    </ul>
    {% elif item[13]==0 %}
    <label class="form-label">Show artwork in shop</label>
    <ul>
    <label>
        Type <b>SHOW</b> to confirm:
        <input type="text" name="confirmShow" class="input">
    </label>
    </ul>
    {% endif %}


    <!-- Delete -->
    <hr>

<div class="danger-zone">
    <h3 class="danger-title">Danger zone</h3>

    <label class="form-label danger">
        Delete artwork permanently
    </label>

    <p class="danger-text">
        This action cannot be undone.
    </p>
    <ul>
    <label>
        Type <b>DELETE</b> to confirm:
        <input type="text" name="confirmDelete" class="input danger-input">
    </label>

    <label>
        Confirm password:
        <input type="password" name="password" class="input danger-input">
    </label>
    </ul>
</div>


    <button type="submit" class="submit" id="submit">Save changes</button>

</form>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const thumbInput = document.getElementById('thumbInput');
    const thumbPreview = document.getElementById('thumbPreview');
    if (thumbInput && thumbPreview) {
        const thumbError = document.getElementById('thumbError');
        const thumbMax = parseInt(thumbInput.dataset.maxSize || '0', 10);
        const thumbAllowed = (thumbInput.dataset.allowed || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);

        function updateSubmitDisabled() {
            const exErr = document.getElementById('examplesError');
            const tErr = thumbError;
            const submitBtn = document.getElementById('submit');
            submitBtn.disabled = ((exErr && exErr.textContent) || (tErr && tErr.textContent));
        }

        thumbInput.addEventListener('change', function() {
            thumbError.textContent = '';
            const file = this.files[0];
            if (!file) return updateSubmitDisabled();

            const ext = file.name.split('.').pop().toLowerCase();
            if (thumbMax && file.size > thumbMax) {
                thumbError.textContent = `Thumbnail too large (max ${(thumbMax/1024/1024).toFixed(1)} MB)`;
                return updateSubmitDisabled();
            }
            if (thumbAllowed.length && !thumbAllowed.includes(ext)) {
                thumbError.textContent = `Invalid thumbnail type.`;
                return updateSubmitDisabled();
            }
            if (!file.type || !file.type.startsWith('image/')) {
                thumbError.textContent = `Selected file is not an image.`;
                return updateSubmitDisabled();
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                thumbPreview.src = e.target.result;
            }
            reader.readAsDataURL(file);
            updateSubmitDisabled();
        });
    }

    const examplesInput = document.getElementById('examplesInput');
    const examplesPreview = document.getElementById('examplesPreview');
    if (examplesInput && examplesPreview) {
        const exError = document.getElementById('examplesError');
        const exMax = parseInt(examplesInput.dataset.maxSize || '0', 10);
        const exAllowed = (examplesInput.dataset.allowed || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);

        examplesInput.addEventListener('change', function() {
            examplesPreview.innerHTML = '';
            exError.textContent = '';
            let invalid = false;
            Array.from(this.files).forEach(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                if (exMax && file.size > exMax) {
                    exError.textContent = `File ${file.name} is too large (max ${(exMax/1024/1024).toFixed(1)} MB)`;
                    invalid = true;
                    return;
                }
                if (exAllowed.length && !exAllowed.includes(ext)) {
                    exError.textContent = `File ${file.name} has an invalid type.`;
                    invalid = true;
                    return;
                }
                if (!file.type || !file.type.startsWith('image/')) {
                    exError.textContent = `File ${file.name} is not an image.`;
                    invalid = true;
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '200px';
                    img.style.margin = '5px';
                    examplesPreview.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
            document.getElementById('submit').disabled = invalid || (document.getElementById('thumbError') && document.getElementById('thumbError').textContent);
        });
    }
});
</script>
{% endblock %}
